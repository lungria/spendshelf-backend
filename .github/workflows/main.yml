name: Deploy (main)

on:
  push:
    branches: [ v2/ci-cd ]

jobs:   
  build:    
    runs-on: "ubuntu-20.04"
    env:
      DOCKER_REGISTRY: registry.hub.docker.com      
      DOCKER_IMAGE: suddengunter/spendshelf-backend      
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}  
      # DOCKER_TARGET_PLATFORM: linux/arm/v8                    
    steps:    
      - name: Checkout
        uses: actions/checkout@v2
            
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
        with:
          platforms: all

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: latest
          install: true

      # - name: Available platforms
      #   run: echo ${{ steps.buildx.outputs.platforms }}
    
      - name: Docker Login      
        if: success()      
        run: |        
          echo "${DOCKER_TOKEN}" | docker login ${DOCKER_REGISTRY} --username "${DOCKER_USERNAME}" --password-stdin
    
      - name: Docker Build & Push      
        if: success()      
        run: |        
          docker build build \
          --platform linux/arm/v8 \
          --tag ${{ steps.prepare.outputs.docker_image }}:latest \
          --file ./Dockerfile \
          --output type=image,push=true .